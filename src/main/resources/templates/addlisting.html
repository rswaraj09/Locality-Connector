<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Listing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fb; }
        .container { max-width: 900px; margin: 32px auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.08); }
        h1 { margin: 0 0 16px; font-size: 24px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .card { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 16px; }
        label { display: block; font-weight: 600; margin: 8px 0 4px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        textarea { height: 90px; }
        .btn { background: #2563eb; color: #fff; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
        .btn:hover { background: #1e4fd6; }
        .list { margin-top: 12px; }
        .item { display: flex; justify-content: space-between; align-items: start; gap: 12px; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; }
        .price { font-weight: 700; color: #111827; }
        .muted { color: #6b7280; font-size: 13px; }
        .actions { display: flex; gap: 8px; }
        .btn-secondary { background: #6b7280; }
        .btn-danger { background: #dc2626; }
        .btn-secondary:hover { background: #565d69; }
        .btn-danger:hover { background: #b91c1c; }
        .msg { margin: 12px 0; padding: 10px; border-radius: 8px; display: none; }
        .msg.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .msg.error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const businessNameInput = document.getElementById('businessName');
            const stored = localStorage.getItem('businessName');
            if (stored && !businessNameInput.value) businessNameInput.value = stored;

            loadItems();

            document.getElementById('itemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const businessName = businessNameInput.value.trim();
                const itemName = document.getElementById('itemName').value.trim();
                const itemPrice = document.getElementById('itemPrice').value;
                const itemDescription = document.getElementById('itemDescription').value.trim();

                if (!businessName || !itemName || !itemPrice) {
                    return showMsg('Please fill business name, item name and price.', true);
                }
                try {
                    const res = await fetch('/api/items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ businessName, itemName, itemPrice, itemDescription })
                    });
                    const data = await res.json();
                    if (!res.ok || data.error) throw new Error(data.error || 'Failed to save');
                    showMsg('Item saved', false);
                    (document.getElementById('itemForm')).reset();
                    if (businessName) localStorage.setItem('businessName', businessName);
                    loadItems();
                } catch (err) {
                    showMsg(err.message, true);
                }
            });
        });

        async function loadItems() {
            const list = document.getElementById('itemsList');
            list.innerHTML = '<div class="muted">Loading...</div>';
            const businessName = document.getElementById('businessName').value.trim() || localStorage.getItem('businessName') || '';
            if (!businessName) {
                list.innerHTML = '<div class="muted">Enter business name to load items.</div>';
                return;
            }
            try {
                const res = await fetch('/api/items?businessName=' + encodeURIComponent(businessName));
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || 'Failed to load items');
                if (!Array.isArray(data) || data.length === 0) {
                    list.innerHTML = '<div class="muted">No items yet.</div>';
                    return;
                }
                list.innerHTML = '';
                data.forEach(it => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div>
                            <div><strong>${it.name}</strong></div>
                            <div class="muted">${it.description ? it.description : ''}</div>
                        </div>
                        <div style="text-align:right">
                          <div class="price">â‚¹ ${Number(it.price).toFixed(2)}</div>
                          <div class="actions">
                            <button class="btn btn-secondary" onclick="editItem('${it.id || it._id}', '${businessName}', '${encodeURIComponent(it.name)}', ${Number(it.price)}, '${encodeURIComponent(it.description || '')}')\">Edit</button>
                            <button class="btn btn-danger" onclick="deleteItem('${it.id || it._id}')\">Delete</button>
                          </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (err) {
                list.innerHTML = '<div class="muted">' + (err.message || 'Failed to load') + '</div>';
            }
        }

        function showMsg(text, isError) {
            const m = document.getElementById('msg');
            m.textContent = text; m.className = 'msg ' + (isError ? 'error' : 'success'); m.style.display = 'block';
            setTimeout(() => m.style.display = 'none', 2500);
        }

        async function deleteItem(id) {
            if (!confirm('Delete this item?')) return;
            try {
                const res = await fetch('/api/items/' + encodeURIComponent(id), { method: 'DELETE' });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || 'Delete failed');
                showMsg('Item deleted', false);
                loadItems();
            } catch (e) {
                showMsg(e.message, true);
            }
        }

        async function editItem(id, businessName, name, price, desc) {
            const newName = prompt('Item name:', decodeURIComponent(name));
            if (newName === null) return;
            const newPriceStr = prompt('Price:', String(price));
            if (newPriceStr === null) return;
            const newDesc = prompt('Description:', decodeURIComponent(desc));
            try {
                const res = await fetch('/api/items/' + encodeURIComponent(id), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemName: newName, itemPrice: parseFloat(newPriceStr), itemDescription: newDesc })
                });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || 'Update failed');
                showMsg('Item updated', false);
                loadItems();
            } catch (e) {
                showMsg(e.message, true);
            }
        }
    </script>
</head>
<body>
<div class="container">
    <h1>Add Listing</h1>
    <div id="msg" class="msg"></div>
    <div class="row">
        <div class="card">
            <h3>Add Item</h3>
            <form id="itemForm">
                <label>Business Name</label>
                <input id="businessName" name="businessName" type="text" placeholder="Business name" value="${sessionScope.loggedInBusinessName}">
                <label>Item Name</label>
                <input id="itemName" name="itemName" type="text" placeholder="e.g., Sugar" required>
                <label>Price</label>
                <input id="itemPrice" name="itemPrice" type="number" step="0.01" min="0" placeholder="e.g., 20" required>
                <label>Description</label>
                <textarea id="itemDescription" name="itemDescription" placeholder="Optional"></textarea>
                <div style="margin-top:12px"><button class="btn" type="submit">Save Item</button></div>
            </form>
        </div>
        <div class="card">
            <h3>Items</h3>
            <div class="list" id="itemsList"></div>
            <div style="margin-top:12px"><button class="btn" onclick="loadItems()">Refresh</button></div>
        </div>
    </div>
</div>
</body>
</html>




